"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
/**
 * This decorator renames collections.
 * It should be used with RenameCollectionDataSourceDecorator, and not the raw DataSourceDecorator
 */
class RenameCollectionCollectionDecorator extends datasource_toolkit_1.CollectionDecorator {
    get name() {
        return this.dataSource.getCollectionName(super.name);
    }
    refineSchema(childSchema) {
        const fields = {};
        for (const [name, oldSchema] of Object.entries(childSchema.fields)) {
            const schema = { ...oldSchema };
            if (schema.type !== 'Column') {
                schema.foreignCollection = this.dataSource.getCollectionName(schema.foreignCollection);
                if (schema.type === 'ManyToMany') {
                    schema.throughCollection = this.dataSource.getCollectionName(schema.throughCollection);
                }
            }
            fields[name] = schema;
        }
        return { ...childSchema, fields };
    }
    /**
     * Override visibility of the markSchemaAsDirty method so that we can call it
     * from the datasource.
     */
    markSchemaAsDirty() {
        return super.markSchemaAsDirty();
    }
}
exports.default = RenameCollectionCollectionDecorator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWNvcmF0b3JzL3JlbmFtZS1jb2xsZWN0aW9uL2NvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx3RUFJeUM7QUFJekM7OztHQUdHO0FBQ0gsTUFBcUIsbUNBQW9DLFNBQVEsd0NBQW1CO0lBR2xGLElBQWEsSUFBSTtRQUNmLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVrQixZQUFZLENBQUMsV0FBNkI7UUFDM0QsTUFBTSxNQUFNLEdBQWdDLEVBQUUsQ0FBQztRQUUvQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEUsTUFBTSxNQUFNLEdBQUcsRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFDO1lBRWhDLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQzVCLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2dCQUV2RixJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssWUFBWSxFQUFFO29CQUNoQyxNQUFNLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztpQkFDeEY7YUFDRjtZQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUM7U0FDdkI7UUFFRCxPQUFPLEVBQUUsR0FBRyxXQUFXLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQUVEOzs7T0FHRztJQUNhLGlCQUFpQjtRQUMvQixPQUFPLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ25DLENBQUM7Q0FDRjtBQWxDRCxzREFrQ0MifQ==